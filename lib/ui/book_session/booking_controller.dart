// lib/ui/booking/booking_controller.dart
import 'dart:convert';

import 'package:get/get.dart';
import 'package:intl/intl.dart';
import 'package:physio_connect/model/doctor_model.dart';
import 'package:physio_connect/utils/enum.dart';
import 'package:razorpay_flutter/razorpay_flutter.dart';
import 'package:uuid/uuid.dart';

import '../../model/bookings_model.dart';
import '../../model/session_type_model.dart';
import '../../model/time_slots_model.dart';
import '../../model/user_model_supabase.dart';
import '../../supabase/supabase_controller.dart';
import '../../utils/app_shared_preference.dart';

class BookingController extends GetxController {
  static BookingController get to => Get.find();

  BookingController();
  SupabaseController supabaseController =
      SupabaseController.to;

  final isLoading = false.obs;

  // Session Type
  final selectedSessionType = Rx<SessionTypeModel?>(null);
  final sessionTypes = <SessionTypeModel>[].obs;
  // Time slots data
  final selectedTimeSlot = Rx<TimeSlotModel?>(null);
  final bookingsModel = Rx<BookingsModel?>(null);
  final timeSlots = <TimeSlotModel>[].obs;

  final selectedDate = DateTime.now().obs;
  // TODO Handle.
  final razorpayPaymentId = ''.obs;

  UserModelSupabase? userModelSupabase;
  @override
  Future<void> onInit() async {
    super.onInit();
    isLoading.value = true;
    userModelSupabase = await UserModelSupabase.getFromSecureStorage();
    await getSessionTypesMaster();
    await getTimeSlotsMaster();
    isLoading.value = false;
  }

  // Load master data
  Future<void> getSessionTypesMaster() async {
    sessionTypes.clear();
    var response = await supabaseController.getSessionTypeMaster();
    sessionTypes.addAll(response);
  }

  // Load master data
  Future<void> getTimeSlotsMaster() async {
    timeSlots.clear();
    selectedTimeSlot.value = null;
    var response = await supabaseController.getTimeSlotsMaster();
    timeSlots.addAll(response);
  }

  // TODO: Doctor object need to pass
  void createAppointment(PaymentSuccessResponse paymentResponse, PaymentStatus paymentStatus) async {
    isLoading.value = true;
    var doctorModel = await DoctorModel.getFromSecureStorage();
    var doctorJson = jsonEncode(doctorModel?.toJson() ?? {});
    var timeslotJson = jsonEncode(selectedTimeSlot.value?.toJson() ?? {});
    var sessionTypeJson = jsonEncode(selectedSessionType.value?.toJson() ?? {});
    var patientJson = jsonEncode(userModelSupabase?.toJson() ?? {});
    // Via Notification Notify doctor about new booking
    await supabaseController.newBookingNotificationToAdmin(doctorModel?.userId ?? 1);
    bookingsModel.value = BookingsModel(
      id: 0, // This will be auto-generated by the database
      userId: userModelSupabase?.id ?? 0,
      bookingStatus: BookingStatus.booked.name,
      timeSlotId: selectedTimeSlot.value?.id ?? 1, // Replace with actual time slot ID
      timeSlotJson: timeslotJson, // Replace with actual time slot ID
      doctorId: doctorModel?.id ?? 1, // Replace with actual doctor ID
      doctorJson: doctorJson, // Replace with actual doctor ID
      sessionTypeId: selectedSessionType.value?.id ?? 1,
      price: selectedSessionType.value?.price ?? 1,
      sessionTypeJson: sessionTypeJson,
      patientJson: patientJson,
      paymentStatus: paymentStatus.name,
      paymentId: paymentResponse.paymentId!,
      orderId: paymentResponse.orderId,
      signature: paymentResponse.signature,
      doctorNotes: "No additional notes provided.",
      bookingDate: DateFormat('yyyy-MM-dd').format(selectedDate.value),
      createdAt: DateTime.now().toString(),
    );
    await supabaseController.createNewBooking(bookingsModel.value!, doctorModel?.userId ?? 1);
    isLoading.value = false;

    // In a real app, this would create the appointment in your database
    final appointmentId = Uuid().v4();

    // Example implementation:
    // final appointment = booking_model.dart(
    //   appointmentId: appointmentId,
    //   userId: 'current-user-id', // Get from auth service
    //   therapistId: 'assigned-therapist-id',
    //   sessionTypeId: selectedSessionType.value!.sessionTypeId,
    //   date: DateFormat('yyyy-MM-dd').format(selectedDate.value),
    //   startTime: selectedTimeSlot.value,
    //   endTime: calculateEndTime(selectedTimeSlot.value, selectedSessionType.value!.durationMinutes),
    //   status: 'booked',
    //   createdAt: DateTime.now(),
    // );

    // Create payment record
    // final payment = PaymentModel(
    //   paymentId: Uuid().v4(),
    //   appointmentId: appointmentId,
    //   amount: selectedSessionType.value!.price,
    //   razorpayPaymentId: razorpayPaymentId.value,
    //   status: 'completed',
    //   timestamp: DateTime.now(),
    // );

    // Save to database
    // databaseService.saveAppointment(appointment);
    // databaseService.savePayment(payment);

    print('Appointment created with ID: $appointmentId');
  }

  String calculateEndTime(String startTime, int durationMinutes) {
    final parts = startTime.split(':');
    final hour = int.parse(parts[0]);
    final minute = int.parse(parts[1]);

    final startDateTime = DateTime(2023, 1, 1, hour, minute);
    final endDateTime = startDateTime.add(Duration(minutes: durationMinutes));

    return '${endDateTime.hour.toString().padLeft(2, '0')}:${endDateTime.minute.toString().padLeft(2, '0')}';
  }
}